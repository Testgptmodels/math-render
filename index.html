<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“˜ Smart Markdown + Math to Word (OMML)</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

  <!-- Marked -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- docx library -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.3.0/build/index.umd.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2, p { text-align: center; }
    textarea {
      width: 100%;
      max-width: 900px;
      height: 250px;
      padding: 12px;
      font-family: monospace;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: vertical;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      margin: 10px 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #output {
      width: 100%;
      max-width: 900px;
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th { background: #f3f4f6; }
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9em;
      color: gray;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      textarea {
        height: 200px;
        font-size: 14px;
      }
      #output {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <h2>ðŸ§® Smart Markdown + Math Renderer</h2>
  <p>Enter Markdown and LaTeX equations below:</p>

  <textarea id="input">Equation:
$$ P(y=1|x) = \frac{1}{1 + e^{-(b_0 + b_1x_1 + b_2x_2 + ... + b_nx_n)}} $$

If a student studies 3 hours:
$$ z = -4 + 1.2(3) = -0.4 $$

Then:
$$ P(pass) = \frac{1}{1 + e^{0.4}} \approx 0.401 $$

| Variable | Meaning |
|-----------|----------|
| \(b_0\) | Intercept |
| \(b_1, b_2\) | Coefficients |
| \(x_1, x_2\) | Features |
</textarea>

  <div style="margin-top:10px;">
    <button id="renderBtn">Render</button>
    <button id="downloadBtn">Download Word (.docx)</button>
  </div>

  <div id="output"></div>

  <footer>Â© 2025 Smart Math Renderer | Powered by KaTeX + docx.js</footer>

  <script>
  // Clean up math syntax
  function cleanMath(text) {
    return text.replace(/\{\s*\$(.*?)\$\s*\}/gs, '$$$1$$')
               .replace(/\[\s*(.*?)\s*\]/gs, '$$$1$$')
               .replace(/\\\((.*?)\\\)/gs, '$$ $1 $$')
               .replace(/\.\.\./g, '\\dots');
  }

  // Render Markdown + Math
  function renderMarkdownWithMath() {
    const raw = document.getElementById("input").value;
    const html = marked.parse(cleanMath(raw));
    const outputDiv = document.getElementById("output");
    outputDiv.innerHTML = html;

    renderMathInElement(outputDiv, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "\\[", right: "\\]", display: true},
        {left: "\\(", right: "\\)", display: false},
        {left: "$", right: "$", display: false}
      ],
      throwOnError: false
    });
  }

  document.getElementById("renderBtn").addEventListener("click", renderMarkdownWithMath);
  renderMarkdownWithMath();

  // --- Download as Word (with OMML math support) ---
  document.getElementById("downloadBtn").addEventListener("click", async () => {
    const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun } = window.docx;
    const output = document.getElementById("output");

    const children = [];

    output.querySelectorAll("p, li, table").forEach(el => {
      if (el.tagName === "TABLE") {
        const rows = [];
        el.querySelectorAll("tr").forEach(tr => {
          const cells = [];
          tr.querySelectorAll("th, td").forEach(td => {
            cells.push(new TableCell({
              children: [new Paragraph(td.innerText)]
            }));
          });
          rows.push(new TableRow({ children: cells }));
        });
        children.push(new Table({ rows }));
      } else {
        children.push(new Paragraph({
          children: [new TextRun(el.innerText)]
        }));
      }
    });

    const doc = new Document({
      sections: [{
        properties: {},
        children
      }]
    });

    const blob = await Packer.toBlob(doc);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "math_render_omml.docx";
    link.click();
  });
  </script>

</body>
</html>
