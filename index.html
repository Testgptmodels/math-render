<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìò Smart Math & Markdown Renderer</title>

  <!-- ‚úÖ Bootstrap for responsive design -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- ‚úÖ KaTeX for fast formula rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

  <!-- ‚úÖ Marked.js for Markdown support -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- ‚úÖ FileSaver.js for saving files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
    }
    textarea {
      width: 100%;
      height: 240px;
      padding: 12px;
      font-family: monospace;
      border-radius: 8px;
      resize: vertical;
      border: 1px solid #ccc;
      background: #fff;
    }
    #output {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 20px;
      overflow-x: auto;
    }
    .btn-custom {
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      border: none;
    }
    .btn-custom:hover {
      background-color: #0056b3;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f3f4f6;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      color: #777;
    }
  </style>
</head>
<body>
<div class="container text-center">
  <h2 class="mb-1">üßÆ Smart Markdown + Formula Renderer</h2>
  <p class="text-muted mb-3">Render equations, tables, and Markdown ‚Äî export as editable Word file (OMML).</p>

  <textarea id="input" class="form-control">
### Logistic Regression Example

Formula:
$$ P(y=1|x) = \frac{1}{1 + e^{-(b_0 + b_1x_1 + b_2x_2)}} $$

Substitute:
$$ b_0=-1,\; b_1=0.5,\; b_2=0.8,\; X_1=2,\; X_2=1 $$

Compute:
$$ z = -1 + (0.5)(2) + (0.8)(1) = 0.8 $$

| Variable | Meaning |
|-----------|----------|
| \(b_0\) | Intercept |
| \(b_1, b_2\) | Coefficients |
| \(x_1, x_2\) | Features |
  </textarea>

  <div class="mt-3">
    <button id="renderBtn" class="btn btn-custom">üîÑ Render</button>
    <button id="exportBtn" class="btn btn-success">‚¨áÔ∏è Export to Word</button>
  </div>

  <div id="output" class="mt-3 text-start"></div>

  <footer>üìò Powered by KaTeX + MathJax + Marked.js | ¬© 2025 Smart Renderer</footer>
</div>

<script>
function cleanMath(text) {
  let cleaned = text;
  cleaned = cleaned.replace(/\{\s*\$(.*?)\$\s*\}/gs, '$$$1$$');
  cleaned = cleaned.replace(/\[\s*(\\?)(.*?)\s*\]/gs, '$$$2$$');
  cleaned = cleaned.replace(/\\\((.*?)\\\)/gs, '$$$1$$');
  cleaned = cleaned.replace(/e\^{-\s*}/g, 'e^{-z}');
  cleaned = cleaned.replace(/\.\.\./g, '\\dots');
  return cleaned;
}

function renderMarkdownWithMath() {
  const raw = document.getElementById("input").value;
  const fixedText = cleanMath(raw);
  const html = marked.parse(fixedText);
  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML = html;

  renderMathInElement(outputDiv, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "\\[", right: "\\]", display: true},
      {left: "\\(", right: "\\)", display: false},
      {left: "$", right: "$", display: false}
    ],
    throwOnError: false
  });
}

// Convert LaTeX ‚Üí OMML for editable Word equation
async function latexToOMML(latex) {
  if (typeof MathJax === "undefined") {
    await new Promise(resolve => {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml.js";
      script.onload = resolve;
      document.head.appendChild(script);
    });
  }
  const mathML = MathJax.tex2mml(latex);
  return `<m:oMathPara xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"><m:oMath>${mathML}</m:oMath></m:oMathPara>`;
}

// Export to Word (.docx) with editable formula
document.getElementById("exportBtn").addEventListener("click", async () => {
  const rawText = document.getElementById("input").value;
  const formulas = [...rawText.matchAll(/\$\$(.*?)\$\$/gs)].map(f => f[1]);
  let bodyContent = `<w:p><w:r><w:t>Rendered Document</w:t></w:r></w:p>`;

  for (const f of formulas) {
    const omml = await latexToOMML(f);
    bodyContent += omml;
  }

  const content = `
  <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
              xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math">
    <w:body>
      ${bodyContent}
      <w:p/>
    </w:body>
  </w:document>`;

  const blob = new Blob([content], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
  saveAs(blob, "Rendered_Math_OMML.docx");
});

document.getElementById("renderBtn").addEventListener("click", renderMarkdownWithMath);
renderMarkdownWithMath();
</script>
</body>
</html>
