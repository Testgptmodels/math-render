<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üßÆ Smart Math + Markdown Renderer</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- JSZip + Docxtemplater for .docx creation -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.31.4/build/docxtemplater.min.js"></script>

  <!-- MathJax (for OMML conversion) -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml.js"></script>

  <style>
    body { background:#f8fafc; font-family:"Segoe UI",sans-serif; margin:0; padding:20px; }
    .container { max-width:900px; }
    textarea { width:100%; height:240px; padding:12px; border-radius:8px; border:1px solid #ccc; resize:vertical; }
    #output { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-top:20px; overflow-x:auto; }
    footer { text-align:center; margin-top:25px; color:#555; font-size:0.9em; }
  </style>
</head>
<body>
<div class="container text-center">
  <h2 class="mb-1">üßÆ Smart Markdown + Formula Renderer</h2>
  <p class="text-muted mb-3">Render equations, tables & Markdown ‚Äî export editable Word file (OMML).</p>

  <textarea id="input" class="form-control">
### Logistic Regression Example

Formula:
$$ P(y=1|x) = \frac{1}{1 + e^{-(b_0 + b_1x_1 + b_2x_2)}} $$

Substitute:
$$ b_0=-1,\; b_1=0.5,\; b_2=0.8,\; X_1=2,\; X_2=1 $$

Compute:
$$ z = -1 + (0.5)(2) + (0.8)(1) = 0.8 $$

| Variable | Meaning |
|-----------|----------|
| \(b_0\) | Intercept |
| \(b_1, b_2\) | Coefficients |
| \(x_1, x_2\) | Features |
  </textarea>

  <div class="mt-3">
    <button id="renderBtn" class="btn btn-primary">üîÑ Render</button>
    <button id="exportBtn" class="btn btn-success">‚¨áÔ∏è Export to Word</button>
  </div>

  <div id="output" class="mt-3 text-start"></div>

  <footer id="statsFooter">
    üìò Powered by KaTeX + MathJax + Marked.js |
    üßÆ Formulas Rendered: <span id="formulaCount">0</span> |
    ‚¨áÔ∏è Downloads: <span id="downloadCount">0</span> |
    üëÅ Visits: <span id="visitCount">0</span>
  </footer>
</div>

<script>
/* ---------- Utility ---------- */
function cleanMath(text) {
  return text
    .replace(/\{\s*\$(.*?)\$\s*\}/gs, '$$$1$$')
    .replace(/\[\s*(\\?)(.*?)\s*\]/gs, '$$$2$$')
    .replace(/\\\((.*?)\\\)/gs, '$$$1$$')
    .replace(/\.\.\./g, '\\dots');
}

/* ---------- Markdown + KaTeX Renderer ---------- */
function renderMarkdownWithMath() {
  const raw = document.getElementById("input").value;
  const fixedText = cleanMath(raw);
  const html = marked.parse(fixedText);
  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML = html;

  renderMathInElement(outputDiv, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "\\[", right: "\\]", display: true},
      {left: "\\(", right: "\\)", display: false},
      {left: "$", right: "$", display: false}
    ],
    throwOnError: false
  });

  // Update formula counter
  const formulas = (raw.match(/\$\$/g) || []).length / 2;
  localStorage.setItem("formulaCount", formulas + (parseInt(localStorage.getItem("formulaCount") || 0)));
  updateStats();
}

/* ---------- LaTeX ‚Üí OMML ---------- */
async function latexToOMML(latex) {
  const mathML = MathJax.tex2mml(latex);
  return `<m:oMathPara xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"><m:oMath>${mathML}</m:oMath></m:oMathPara>`;
}

/* ---------- Export to Word ---------- */
document.getElementById("exportBtn").addEventListener("click", async () => {
  const rawText = document.getElementById("input").value;
  const formulas = [...rawText.matchAll(/\$\$(.*?)\$\$/gs)].map(f => f[1]);
  let docBody = "";

  for (const f of formulas) {
    const omml = await latexToOMML(f);
    docBody += omml + "<w:p/>";
  }

  const documentXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
              xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math">
    <w:body>${docBody}</w:body>
  </w:document>`;

  const zip = new PizZip();
  zip.file("word/document.xml", documentXML);
  zip.file("[Content_Types].xml",
    `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
     <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
       <Default Extension="xml" ContentType="application/xml"/>
       <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
       <Override PartName="/word/document.xml"
       ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
     </Types>`
  );
  const rels =
    `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
     <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
       <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"
       Target="word/document.xml"/>
     </Relationships>`;
  zip.file("_rels/.rels", rels);

  const blob = zip.generate({ type: "blob" });
  saveAs(blob, "Rendered_Math_OMML.docx");

  // Update download counter
  localStorage.setItem("downloadCount", parseInt(localStorage.getItem("downloadCount") || 0) + 1);
  updateStats();
});

/* ---------- Statistics ---------- */
function updateStats() {
  document.getElementById("formulaCount").innerText = localStorage.getItem("formulaCount") || 0;
  document.getElementById("downloadCount").innerText = localStorage.getItem("downloadCount") || 0;
  document.getElementById("visitCount").innerText = localStorage.getItem("visitCount") || 0;
}

// Increment visits
window.addEventListener("load", () => {
  const visits = parseInt(localStorage.getItem("visitCount") || 0) + 1;
  localStorage.setItem("visitCount", visits);
  updateStats();
});

/* ---------- Event Bindings ---------- */
document.getElementById("renderBtn").addEventListener("click", renderMarkdownWithMath);
renderMarkdownWithMath();
</script>
</body>
</html>
