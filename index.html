<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“˜ Smart Markdown + Math Renderer + Word Export</title>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

<!-- Marked.js -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- docx.js -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.3.0/build/index.umd.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
    background: #f8fafc;
  }
  textarea {
    width: 100%;
    height: 250px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover {
    background: #0056b3;
  }
  #output {
    margin-top: 20px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
  }
  th {
    background: #f3f4f6;
  }
  footer {
    text-align: center;
    font-size: 0.9em;
    margin-top: 25px;
    color: gray;
  }
</style>
</head>
<body>

<h2 style="text-align:center;">ðŸ§® Smart Markdown + Formula Renderer</h2>
<p style="text-align:center;">Type text or equations (Markdown + LaTeX supported)</p>

<textarea id="input">Equation:
$$ P(y=1|x) = \frac{1}{1 + e^{-(b_0 + b_1x_1 + b_2x_2 + ... + b_nx_n)}} $$

If a student studies 3 hours:
$$ z = -4 + 1.2(3) = -0.4 $$

Then:
$$ P(pass) = \frac{1}{1 + e^{0.4}} \approx 0.401 $$

| Variable | Meaning |
|-----------|----------|
| \(b_0\) | Intercept |
| \(b_1, b_2\) | Coefficients |
| \(x_1, x_2\) | Features |
</textarea>

<br>
<button id="renderBtn">Render</button>
<button id="downloadBtn">Download Word (.docx)</button>

<div id="output"></div>

<footer>Â© 2025 Smart Math Renderer | Powered by KaTeX + docx.js</footer>

<script>
function cleanMath(text) {
  let cleaned = text;
  cleaned = cleaned.replace(/\{\s*\$(.*?)\$\s*\}/gs, '$$$1$$');
  cleaned = cleaned.replace(/\[\s*(.*?)\s*\]/gs, '$$$1$$');
  cleaned = cleaned.replace(/\\\((.*?)\\\)/gs, '$$$1$$');
  cleaned = cleaned.replace(/\.\.\./g, '\\dots');
  return cleaned;
}

function renderMarkdownWithMath() {
  const raw = document.getElementById("input").value;
  const fixedText = cleanMath(raw);
  const html = marked.parse(fixedText);
  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML = html;
  renderMathInElement(outputDiv, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "\\[", right: "\\]", display: true},
      {left: "\\(", right: "\\)", display: false},
      {left: "$", right: "$", display: false}
    ],
    throwOnError: false
  });
}

document.getElementById("renderBtn").addEventListener("click", renderMarkdownWithMath);
renderMarkdownWithMath();

document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun } = window.docx;
  const outputDiv = document.getElementById("output");

  const paras = [];
  outputDiv.querySelectorAll("p, div, li").forEach(el => {
    paras.push(new Paragraph(el.innerText));
  });

  const tables = [];
  outputDiv.querySelectorAll("table").forEach(tbl => {
    const rows = [];
    tbl.querySelectorAll("tr").forEach(tr => {
      const cells = [];
      tr.querySelectorAll("th, td").forEach(td => {
        cells.push(new TableCell({
          children: [new Paragraph(td.innerText)]
        }));
      });
      rows.push(new TableRow({ children: cells }));
    });
    tables.push(new Table({ rows }));
  });

  const doc = new Document({
    sections: [{
      properties: {},
      children: [...paras, ...tables]
    }]
  });

  const blob = await Packer.toBlob(doc);
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "math_render.docx";
  link.click();
});
</script>

</body>
</html>
